// Generated by CoffeeScript 1.9.2
(function() {
  var _, baseUrl, getAuthRequest, globalCredentials, gutil, keyCount, merge, request,
    hasProp = {}.hasOwnProperty;

  baseUrl = "https://phraseapp.com/api/v2";

  request = require('request').defaults({
    baseUrl: baseUrl
  });

  gutil = require('gulp-util');

  merge = require('deep-merge')(function(a, b) {
    return a;
  });

  _ = require('highland');

  keyCount = function(obj) {
    var count, key, val;
    count = 0;
    for (key in obj) {
      if (!hasProp.call(obj, key)) continue;
      val = obj[key];
      if (typeof val === "object") {
        count += keyCount(val);
      } else {
        count += 1;
      }
    }
    return count;
  };

  globalCredentials = {};

  getAuthRequest = function(options) {
    var token;
    token = options.accessToken || globalCredentials.accessToken;
    if (token == null) {
      throw new Error("A Phraseapp access token must be present");
    }
    return request.defaults({
      headers: {
        'Authorization': "token " + token
      }
    });
  };

  exports.init = function(credentials) {
    if (credentials == null) {
      credentials = {};
    }
    return globalCredentials = credentials;
  };

  exports.upload = function(options) {
    var project;
    if (options == null) {
      options = {};
    }
    request = getAuthRequest(options);
    project = options.projectID || globalCredentials.projectID;
    if (project == null) {
      throw new Error("A Phraseapp project id must be present");
    }
    return _().each(function(vinyl) {
      var file;
      file = {
        value: vinyl.contents,
        options: {
          filename: vinyl.relative,
          contentType: 'application/octet-stream'
        }
      };
      return request({
        url: "/projects/" + project + "/uploads/",
        method: 'POST',
        formData: {
          file: file,
          locale_id: '55f5b7c3de7d213e135ee9e624bdf9e1',
          file_format: 'nested_json'
        }
      }, function(err, res) {
        return gutil.log(res.statusCode);
      });
    });
  };

  exports.download = function(options) {
    var project;
    if (options == null) {
      options = {};
    }
    request = getAuthRequest(options);
    project = options.projectID || globalCredentials.projectID;
    if (project == null) {
      throw new Error("A Phraseapp project id must be present");
    }
    request = request.defaults({
      headers: {
        'Authorization': "token " + token
      }
    });
    return _(request("/projects/" + project + "/locales/")).reduce1(_.add).flatMap(function(body) {
      var locale, locales;
      locales = JSON.parse(body.toString());
      return _((function() {
        var i, len, results;
        results = [];
        for (i = 0, len = locales.length; i < len; i++) {
          locale = locales[i];
          results.push({
            code: locale.code,
            url: "/projects/" + project + "/locales/" + locale.code + "/download",
            qs: {
              file_format: 'nested_json',
              include_empty_translations: locale.code === options.base || options.includeEmpty ? "1" : "0"
            }
          });
        }
        return results;
      })());
    }).map(function(query) {
      return _(request(query)).reduce1(_.add).map(function(body) {
        var text;
        text = JSON.parse(body.toString());
        gutil.log(gutil.colors.green('phraseapp'), "Downloaded " + query.code + ".json", gutil.colors.cyan((keyCount(text)) + " translations"));
        return {
          code: query.code,
          text: text
        };
      });
    }).parallel(2).group('code').consume(function(err, data, push, next) {
      var code, out, results, text;
      if (err) {
        push(err);
        return next();
      }
      results = [];
      for (code in data) {
        text = data[code][0].text;
        out = text;
        if (options.base) {
          out = merge(text, data[options.base][0].text);
        }
        push(null, new gutil.File({
          cwd: "",
          base: "",
          path: code + ".json",
          contents: new Buffer(JSON.stringify(out, null, '  '))
        }));
        results.push(next());
      }
      return results;
    });
  };

}).call(this);
